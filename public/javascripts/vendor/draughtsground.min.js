var Draughtsground=function(){"use strict";const e=["p1","p2"],t=["01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50"],n=["b8","d8","f8","h8","a7","c7","e7","g7","b6","d6","f6","h6","a5","c5","e5","g5","b4","d4","f4","h4","a3","c3","e3","g3","b2","d2","f2","h2","a1","c1","e1","g1"],o={1:"b8",2:"d8",3:"f8",4:"h8",5:"a7",6:"c7",7:"e7",8:"g7",9:"b6",10:"d6",11:"f6",12:"h6",13:"a5",14:"c5",15:"e5",16:"g5",17:"b4",18:"d4",19:"f4",20:"h4",21:"a3",22:"c3",23:"e3",24:"g3",25:"b2",26:"d2",27:"f2",28:"h2",29:"a1",30:"c1",31:"e1",32:"g1"};const r=["8","7","6","5","4","3","2","1"],a=["a","b","c","d","e","f","g","h"],i=(e,n)=>t[e[0]+n[0]/2*(e[1]-1)-1],s=e=>e<10?"0"+e.toString():e.toString(),l=(e,t)=>c(parseInt(e),t),c=(e,t)=>[(e-1)%(t[0]/2)+1,(e-1+(t[0]/2-(e-1)%(t[0]/2)))/(t[1]/2)];const d=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},p=e=>"p1"===e?"p2":"p1";function u(e,t){return void 0!==e&&-1!==e.indexOf(t)}const g=(e,t)=>{const n=e[0]-t[0],o=e[1]-t[1];return n*n+o*o},f=(e,t)=>e.role===t.role&&e.playerIndex===t.playerIndex,h=(e,t,n,o,r,a)=>{const i=t[0]/2-.5;return 0!==a?[(n?a-.5+e[0]:i-(a-.5+e[0]))*o,(n?e[1]-1:t[1]-e[1])*r]:[(n?(e[1]%2!=0?-.5:-1)+e[0]:i-((e[1]%2!=0?-.5:-1)+e[0]))*o,(n?e[1]-1:t[1]-e[1])*r]},m=(e,t)=>{const n=e.width/(t[0]/2),o=e.height/t[1];return(e,r,a)=>h(e,t,r,n,o,a)},v=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},b=(e,t)=>{e.style.left=t[0]+"%",e.style.top=t[1]+"%"},y=e=>v(e,[-99999,-99999]),w=e=>e.clientX||0===e.clientX?[e.clientX,e.clientY]:e.touches&&e.targetTouches[0]?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0,x=e=>2===e.buttons||2===e.button,k=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function M(e){for(const t in e)return!1;return!0}const I=[[-1,-1,-1],[6,7,11],[7,8,12],[8,9,13],[9,10,14],[10,-1,15],[-1,11,16],[11,12,17],[12,13,18],[13,14,19],[14,15,20],[16,17,21],[17,18,22],[18,19,23],[19,20,24],[20,-1,25],[-1,21,26],[21,22,27],[22,23,28],[23,24,29],[24,25,30],[26,27,31],[27,28,32],[28,29,33],[29,30,34],[30,-1,35],[-1,31,36],[31,32,37],[32,33,38],[33,34,39],[34,35,40],[36,37,41],[37,38,42],[38,39,43],[39,40,44],[40,-1,45],[-1,41,46],[41,42,47],[42,43,48],[43,44,49],[44,45,50],[46,47,-1],[47,48,-1],[48,49,-1],[49,50,-1],[50,-1,-1],[-1,-1,-1],[-1,-1,-1],[-1,-1,-1],[-1,-1,-1],[-1,-1,-1]],S=[[-1,-1,-1],[5,6,9],[6,7,10],[7,8,11],[8,-1,12],[-1,9,13],[9,10,14],[10,11,15],[11,12,16],[13,14,17],[14,15,18],[15,16,19],[16,-1,20],[-1,17,21],[17,18,22],[18,19,23],[19,20,24],[21,22,25],[22,23,26],[23,24,27],[24,-1,28],[-1,25,29],[25,26,30],[26,27,31],[27,28,32],[29,30,-1],[30,31,-1],[31,32,-1],[32,-1,-1],[-1,-1,-1],[-1,-1,-1],[-1,-1,-1],[-1,-1,-1]],P=[[-1,-1,-1],[-1,-1,-1],[-1,-1,-1],[-1,-1,-1],[-1,-1,-1],[-1,-1,-1],[-1,1,-1],[1,2,-1],[2,3,-1],[3,4,-1],[4,5,-1],[6,7,1],[7,8,2],[8,9,3],[9,10,4],[10,-1,5],[-1,11,6],[11,12,7],[12,13,8],[13,14,9],[14,15,10],[16,17,11],[17,18,12],[18,19,13],[19,20,14],[20,-1,15],[-1,21,16],[21,22,17],[22,23,18],[23,24,19],[24,25,20],[26,27,21],[27,28,22],[28,29,23],[29,30,24],[30,-1,25],[-1,31,26],[31,32,27],[32,33,28],[33,34,29],[34,35,30],[36,37,31],[37,38,32],[38,39,33],[39,40,34],[40,-1,35],[-1,41,36],[41,42,37],[42,43,38],[43,44,39],[44,45,40]],z=[[-1,-1,-1],[-1,-1,-1],[-1,-1,-1],[-1,-1,-1],[-1,-1,-1],[-1,1,-1],[1,2,-1],[2,3,-1],[3,4,-1],[5,6,1],[6,7,2],[7,8,3],[8,-1,4],[-1,9,5],[9,10,6],[10,11,7],[11,12,8],[13,14,9],[14,15,10],[15,16,11],[16,-1,12],[-1,17,13],[17,18,14],[18,19,15],[19,20,16],[21,22,17],[22,23,18],[23,24,19],[24,-1,20],[-1,25,21],[25,26,22],[26,27,23],[27,28,24]],L=[[-1,-1],[-1,2],[1,3],[2,4],[3,5],[4,-1],[-1,7],[6,8],[7,9],[8,10],[9,-1],[-1,12],[11,13],[12,14],[13,15],[14,-1],[-1,17],[16,18],[17,19],[18,20],[19,-1],[-1,22],[21,23],[22,24],[23,25],[24,-1],[-1,27],[26,28],[27,29],[28,30],[29,-1],[-1,32],[31,33],[32,34],[33,35],[34,-1],[-1,37],[36,38],[37,39],[38,40],[39,-1],[-1,42],[41,43],[42,44],[43,45],[44,-1],[-1,47],[46,48],[47,49],[48,50],[49,-1]],C=[[-1,-1],[-1,2],[1,3],[2,4],[3,-1],[-1,6],[5,7],[6,8],[7,-1],[-1,10],[9,11],[10,12],[11,-1],[-1,14],[13,15],[14,16],[15,-1],[-1,18],[17,19],[18,20],[19,-1],[-1,22],[21,23],[22,24],[23,-1],[-1,26],[25,27],[26,28],[27,-1],[-1,30],[29,31],[30,32],[31,-1]];function N(e,t,n,o){const r=e.get(n),a=Number(n);if(void 0===r||isNaN(a))return new Array;const i=o&&("frisian"===o||"frysk"===o),l=o&&("portuguese"===o||"english"===o),c=o&&"english"===o,d=10===t[0],p=d?P:z,u=d?I:S,g=d?L:C,f=new Array;if("man"===r.role||c){if("king"===r.role||!l||"p1"===r.playerIndex)for(let t=0;t<(i?3:2);t++){let n=p[a][t];if(-1!=n){const o=s(n);("p1"===r.playerIndex&&t<2||"king"===r.role)&&f.push(o);const a=e.get(o);void 0!==a&&a.playerIndex===r.playerIndex||(n=p[n][t],-1!==n&&f.push(s(n)))}}if("king"===r.role||!l||"p2"===r.playerIndex)for(let t=0;t<(i?3:2);t++){let n=u[a][t];if(-1!=n){const o=s(n);("p2"===r.playerIndex&&t<2||"king"===r.role)&&f.push(o);const a=e.get(o);void 0!==a&&a.playerIndex===r.playerIndex||(n=u[n][t],-1!==n&&f.push(s(n)))}}if(i)for(let t=0;t<2;t++){let n=g[a][t];if(-1!=n){const o=e.get(s(n));void 0!==o&&o.playerIndex===r.playerIndex||(n=g[n][t],-1!==n&&f.push(s(n)))}}}else if("king"===r.role){for(let e=0;e<(i?3:2);e++){let t=p[a][e],n=0;for(;-1!=t;)(e<2||n>0)&&f.push(s(t)),t=p[t][e],n++}for(let e=0;e<(i?3:2);e++){let t=u[a][e],n=0;for(;-1!=t;)(e<2||n>0)&&f.push(s(t)),t=u[t][e],n++}if(i)for(let e=0;e<2;e++){let t=g[a][e],n=0;for(;-1!=t;)n>0&&f.push(s(t)),t=g[t][e],n++}}return f}function O(e){const t=[];if(e.length>1)for(let n=0;n<e.length;n+=2)t.push(e.substr(n,2));return t}function K(e,...t){e&&setTimeout((()=>e(...t)),1)}function E(e){e.premovable.current&&(e.premovable.current=void 0,K(e.premovable.events.unset))}function A(e){const t=e.predroppable;t.current&&(t.current=void 0,K(t.events.unset))}function D(e,t,n,o,r,a){const s=r-n,l=a-o,c=0===l?0:l>0?0===s&&Math.abs(l)>=2?2:1:0===s&&Math.abs(l)>=2?-2:-1,d=0===s?0:0===l?s>0?1:-1:o%2==0?s<0?-1:0:s>0?1:0;if(0===d&&0===c)return;const p=[n+d,o+c];if(void 0===p)return;const u=i(p,t),g=e.get(u);return void 0!==g&&"ghostman"!==g.role&&"ghostking"!==g.role?u:D(e,t,n+d,o+c,r,a)}function W(e,n,o,r){const a=e.pieces.get(n);if(n===o||!a){if(r){const n=e.pieces.get(o),r=l(o,e.boardSize);n&&"man"===n.role&&("p1"===n.playerIndex&&1===r[1]||"p2"===n.playerIndex&&r[1]===e.boardSize[1])&&(n.role="king",e.pieces.set(o,n));for(let o=0;o<t.length;o++){const n=t[o],r=e.pieces.get(n);!r||"ghostking"!==r.role&&"ghostman"!==r.role||e.pieces.delete(n)}o==e.selected&&$(e)}return!1}const i=e.movable.captLen&&e.movable.captLen>0,s=e.boardSize,c=i&&e.movable.captureUci&&function(e,t){for(const n of e)if(t(n))return n}(e.movable.captureUci,(e=>e.slice(0,2)===n&&e.slice(-2)===o)),d=l(n,s),p=l(c?c.slice(2,4):o,s),u=i?D(e.pieces,s,d[0],d[1],p[0],p[1]):void 0,g=i&&u?e.pieces.get(u):void 0;o==e.selected&&$(e),K(e.events.move,n,o,g);const f=c?(c.length-2)/2:1,h=c?l(c.slice(c.length-2),s):p,m=e.movable&&e.movable.variant||e.premovable&&e.premovable.variant,v=("russian"===m||!e.movable.captLen||e.movable.captLen<=f||("pool"===m||"english"===m)&&r)&&"man"===a.role&&("p1"===a.playerIndex&&1===h[1]||"p2"===a.playerIndex&&h[1]===e.boardSize[1]),b=!e.movable.free&&v?{role:"king",playerIndex:a.playerIndex}:e.pieces.get(n);if(!b)return!1;if(e.pieces.delete(n),c&&u){e.pieces.delete(u);const t="man"===b.role&&"russian"===m,n="p1"===a.playerIndex?1:e.boardSize[1];let r=!1;for(let o=2;o+4<=c.length;o+=2){const a=l(c.slice(o,o+2),s),i=l(c.slice(o+2,o+4),s),d=D(e.pieces,s,a[0],a[1],i[0],i[1]);d&&e.pieces.delete(d),t&&a[1]===n&&(r=!0)}r&&(b.role="king"),e.pieces.set(o,b)}else if(e.pieces.set(o,b),u){const n=e.pieces.get(u);if(n){const o=n.playerIndex,a=n.role;if(e.pieces.delete(u),!r&&void 0!==e.movable.captLen&&e.movable.captLen>1)"man"===a?e.pieces.set(u,{role:"ghostman",playerIndex:o}):"king"===a&&e.pieces.set(u,{role:"ghostking",playerIndex:o});else for(let n=0;n<t.length;n++){const o=t[n],r=e.pieces.get(o);!r||"ghostking"!==r.role&&"ghostman"!==r.role||e.pieces.delete(o)}}}return e.lastMove&&e.lastMove.length&&i&&e.lastMove[e.lastMove.length-1]===n?(e.animateFrom=e.lastMove.length-1,c?e.lastMove=e.lastMove.concat(O(c.slice(2))):e.lastMove.push(o)):(e.animateFrom=0,e.lastMove=c?O(c):[n,o]),K(e.events.change),g||!0}function q(e,t,n,o){if(e.pieces.has(n)){if(!o)return!1;e.pieces.delete(n)}return K(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],K(e.events.change),e.movable.dests=void 0,e.turnPlayerIndex=p(e.turnPlayerIndex),!0}function F(e,t,n){const o=W(e,t,n);return o&&(e.movable.dests=void 0,(!e.movable.captLen||e.movable.captLen<=1)&&(e.turnPlayerIndex=p(e.turnPlayerIndex)),e.animation.current=void 0),o}function R(e,t,n){if(_(e,t,n)){const o=F(e,t,n);if(o){const r=e.hold.stop();$(e);const a={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==o&&(a.captured=o),K(e.movable.events.after,t,n,a),!0}}else if(function(e,t,n){return t!==n&&H(e,t)&&u(N(e.pieces,e.boardSize,t,e.premovable.variant),n)}(e,t,n))return function(e,t,n,o){A(e),e.premovable.current=[t,n],K(e.premovable.events.set,t,n,o)}(e,t,n,{ctrlKey:e.stats.ctrlKey}),$(e),!0;return $(e),!1}function j(e,t,n,o){const r=e.pieces.get(t);r&&(function(e,t,n){const o=e.pieces.get(t);return!!o&&n&&(t===n||!e.pieces.has(n))&&("both"===e.movable.playerIndex||e.movable.playerIndex===o.playerIndex&&e.turnPlayerIndex===o.playerIndex)}(e,t,n)||o)?(e.pieces.delete(t),q(e,r,n,o),K(e.movable.events.afterNewPiece,r.role,n,{predrop:!1})):r&&function(e,t,n){const o=e.pieces.get(t),r=e.pieces.get(n);return!!o&&(!r||r.playerIndex!==e.movable.playerIndex)&&e.predroppable.enabled&&e.movable.playerIndex===o.playerIndex&&e.turnPlayerIndex!==o.playerIndex}(e,t,n)?function(e,t,n){E(e),e.predroppable.current={role:t,key:n},K(e.predroppable.events.set,t,n)}(e,r.role,n):(E(e),A(e)),e.pieces.delete(t),$(e)}function B(e,t,n){if(K(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return $(e),void e.hold.cancel();if((e.selectable.enabled||n)&&e.selected!==t&&R(e,e.selected,t)){e.stats.dragged=!1;const n=e.animateFrom?e.animateFrom+1:1;return void(void 0!==e.movable.captLen&&e.movable.captLen>(e.lastMove?e.lastMove.length-n:1)&&T(e,t))}}(U(e,t)||H(e,t))&&(T(e,t),e.hold.start())}function T(e,t){e.selected=t,H(e,t)?e.premovable.dests=N(e.pieces,e.boardSize,t,e.premovable.variant):e.premovable.dests=void 0}function $(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function U(e,t){const n=e.pieces.get(t);return!!n&&("both"===e.movable.playerIndex||e.movable.playerIndex===n.playerIndex&&e.turnPlayerIndex===n.playerIndex)}function _(e,t,n){return t!==n&&U(e,t)&&(e.movable.free||!!e.movable.dests&&u(e.movable.dests.get(t),n))}function H(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.playerIndex===n.playerIndex&&e.turnPlayerIndex!==n.playerIndex}function G(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],o=t[1];let r=!1;if(_(e,n,o)){const t=F(e,n,o);if(t){const a={premove:!0};!0!==t&&(a.captured=t),K(e.movable.events.after,n,o,a),r=!0}}return E(e),r}function Z(e){E(e),A(e),$(e)}function X(e){e.movable.playerIndex=e.movable.dests=e.animation.current=void 0,Z(e)}function Y(e,t,n,o){let r=Math.ceil(t[1]*((e[1]-o.top)/o.height));n||(r=t[1]+1-r);let a=Math.ceil(t[0]*((e[0]-o.left)/o.width));if(n||(a=t[0]+1-a),r%2!=0){if(a%2!=0)return;a/=2}else{if(a%2==0)return;a=(a+1)/2}return a>0&&a<=t[0]/2&&r>0&&r<=t[1]?i([a,r],t):void 0}function Q(e,t,n,o){let r=Math.ceil(t[1]*((e[1]-o.top)/o.height));n||(r=t[1]+1-r);let a=Math.ceil(t[0]*((e[0]-o.left)/o.width));if(n||(a=t[0]+1-a),r%2!=0){if(a%2!=0)return!0}else if(a%2==0)return!0;return!1}function V(e){return e.boardSize[0]*e.boardSize[1]/2}function J(e){return"p1"===e.orientation}const ee="W31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50:B1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20";function te(e,t){const o=new Map;if(!e)return o;"start"===e&&(e=ee);for(const r of e.split(":")){if(r.length<=1)continue;const e=r.slice(0,1);let a;if("W"===e.toUpperCase())a="p1";else{if("B"!==e.toUpperCase())continue;a="p2"}const i=r.slice(1).split(",");for(const r of i){if(!r)continue;let e,i;switch(r.slice(0,1)){case"K":i="king",e=r.slice(1);break;case"G":i="ghostman",e=r.slice(1);break;case"P":i="ghostking",e=r.slice(1);break;default:i="man",e=r}1===e.length&&(e="0"+e);let s=parseInt(e);s||(s=n.indexOf(e)+1),s&&(!t||s<=t)&&o.set(e,{playerIndex:a,role:i})}}return o}function ne(e,t){if(t.movable&&t.movable.dests&&(e.movable.dests=void 0),t.movable&&t.movable.captureUci&&(e.movable.captureUci=void 0),re(e,t),t.fen&&(e.pieces=te(t.fen,V(e)),e.drawable.shapes=[],e.highlight&&e.highlight.kingMoves)){const n=function(e){if(!e)return;"start"===e&&(e=ee);const t=e.split(":"),n=t.length?t[t.length-1]:"";if(0!==n.indexOf("+"))return;const o=n.split("+").filter((function(e){return 0!=e.length}));if(2!==o.length)return;const r=parseInt(o[1].slice(0,1)),a=parseInt(o[0].slice(0,1)),i={p1:{count:r},p2:{count:a}};return r>0&&(i.p1.key=o[1].slice(1)),a>0&&(i.p2.key=o[0].slice(1)),i}(t.fen);n&&oe(e,n)}Object.prototype.hasOwnProperty.call(t,"lastMove")&&!t.lastMove?(e.lastMove=void 0,e.animateFrom=void 0):t.lastMove&&(e.lastMove=t.lastMove,e.animateFrom=void 0),void 0!==t.captureLength&&(e.movable.captLen=t.captureLength),e.selected&&T(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1)}function oe(e,t){if(t.p1.count>0&&t.p1.key){const n=e.pieces.get(t.p1.key);n&&"king"===n.role&&"p1"===n.playerIndex&&(n.kingMoves=t.p1.count)}if(t.p2.count>0&&t.p2.key){const n=e.pieces.get(t.p2.key);n&&"king"===n.role&&"p2"===n.playerIndex&&(n.kingMoves=t.p2.count)}}function re(e,t){for(const n in t)ae(e[n])&&ae(t[n])?re(e[n],t[n]):e[n]=t[n]}function ae(e){return"object"==typeof e}function ie(e,n,o=!1,r=!1){return n.animation.enabled?function(e,n,o=!1,r=!1){const a=new Map(n.pieces),i=e(n),s=function(e,n,o=!1,r=!1){const a=[],i=[];let s=[],c=[];const d=new Map,p={},u=n.boardSize,h=n.movable&&n.movable.variant||n.premovable&&n.premovable.variant;let m,v,b,y=0;for(const[t,l]of e)d.set(t,le(t,u,l)),"ghostman"!==l.role&&"ghostking"!==l.role||y++;for(const l of t)m=n.pieces.get(l),v=d.get(l),m?v?f(m,v.piece)||("p1"===v.piece.playerIndex?a.push(v):i.push(v),"p1"===m.playerIndex?s.push(le(l,u,m)):c.push(le(l,u,m))):"p1"===m.playerIndex?s.push(le(l,u,m)):c.push(le(l,u,m)):v&&("p1"===v.piece.playerIndex?a.push(v):i.push(v));const w={anims:new Map,captures:new Map,tempRole:new Map,fadings:new Map};let x={anims:new Map,captures:new Map,tempRole:new Map,fadings:new Map};s.length>1&&a.length>0&&(s=s.sort(((e,t)=>g(a[0].pos,e.pos)-g(a[0].pos,t.pos))));c.length>1&&i.length>0&&(c=c.sort(((e,t)=>g(i[0].pos,e.pos)-g(i[0].pos,t.pos))));const k=!r&&(0===y||n.animateFrom)&&n.lastMove&&n.lastMove.length>2,M=n.animateFrom||0;if(!o&&k&&n.lastMove&&n.lastMove[M]===n.lastMove[n.lastMove.length-1]){const e=n.lastMove[M];m=n.pieces.get(e),v=d.get(e),m&&v&&"p1"===m.playerIndex&&0!==i.length?(a.push(v),s.push(le(e,u,m))):m&&v&&"p2"===m.playerIndex&&0!==a.length&&(i.push(v),c.push(le(e,u,m)))}const I=a.concat(i),S=s.concat(c);S.length&&I.length&&!o&&S.forEach((t=>{let o=!1,r=I.filter((e=>!p[e.key]&&t.piece.playerIndex===e.piece.playerIndex&&(t.piece.role===e.piece.role||"man"===e.piece.role&&"king"===t.piece.role&&de(t.piece.playerIndex,t.pos,u)||"king"===e.piece.role&&"man"===t.piece.role&&de(e.piece.playerIndex,e.pos,u))));var a;if(r.length||"russian"!==h&&"pool"!==h&&"english"!==h||(o=!0,r=I.filter((e=>!p[e.key]&&t.piece.playerIndex===e.piece.playerIndex&&("man"===e.piece.role&&"king"===t.piece.role||"king"===e.piece.role&&"man"===t.piece.role)))),a=t,v=r.sort(((e,t)=>g(a.pos,e.pos)-g(a.pos,t.pos)))[0],v){p[v.key]=!0;let r="man"===v.piece.role&&"king"===t.piece.role&&(o||de(t.piece.playerIndex,t.pos,u))?"man":void 0;if(k&&n.lastMove&&n.lastMove[M]===v.key&&n.lastMove[n.lastMove.length-1]===t.key){let o,a=l(n.lastMove[M+1],u);w.anims.set(t.key,pe(v.pos,a)),w.nextPlan=x,r&&w.tempRole.set(t.key,r);const i=new Array;let s=D(e,u,v.pos[0],v.pos[1],a[0],a[1]);if(s){const t=e.get(s);t&&(i.push(s),e.set(s,ce(t)))}w.captures=new Map,I.forEach((e=>{e.piece.playerIndex!==t.piece.playerIndex&&(-1!==i.indexOf(e.key)?w.captures.set(e.key,ce(e.piece)):w.captures.set(e.key,e.piece))}));let c={anims:new Map,captures:new Map,tempRole:new Map,fadings:new Map};for(b=M+2;b<n.lastMove.length;b++){o=l(n.lastMove[b],u);const d=pe(a,o);if(d[2]=a[0]-t.pos[0],d[3]=a[1]-t.pos[1],x.anims.set(t.key,d),x.nextPlan=c,r&&("russian"===h&&de(t.piece.playerIndex,a,u)?r=void 0:x.tempRole.set(t.key,r)),s=D(e,u,a[0],a[1],o[0],o[1]),s){const t=e.get(s);t&&(i.push(s),e.set(s,ce(t)))}x.captures=new Map,I.forEach((e=>{e.piece.playerIndex!==t.piece.playerIndex&&(-1!==i.indexOf(e.key)?x.captures.set(e.key,ce(e.piece)):x.captures.set(e.key,e.piece))})),a=o,x=c,c={anims:new Map,captures:new Map,tempRole:new Map,fadings:new Map}}}else w.anims.set(t.key,pe(v.pos,t.pos)),r&&w.tempRole.set(t.key,r)}}));return w}(a,n,o,r);if(M(s.anims))n.animation.current&&!function(e,t){if(!e&&!t)return!0;if(!e||!t||e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}(n.animation.current.lastMove,n.lastMove)&&(n.animation.current=void 0),n.dom.redraw();else{const e=n.animation.current&&n.animation.current.start;n.animation.current={start:performance.now(),frequency:(s.nextPlan&&!M(s.nextPlan.anims)?2.2:1)/n.animation.duration,plan:s,lastMove:n.lastMove},e||ue(n,performance.now())}return i}(e,n,o,r):se(e,n)}function se(e,t){const n=e(t);return t.dom.redraw(),n}function le(e,t,n){return{key:e,pos:l(e,t),piece:n}}function ce(e){return"man"===e.role?{role:"ghostman",playerIndex:e.playerIndex,promoted:e.promoted,kingMoves:e.kingMoves}:"king"===e.role?{role:"ghostking",playerIndex:e.playerIndex,promoted:e.promoted,kingMoves:e.kingMoves}:{role:e.role,playerIndex:e.playerIndex,promoted:e.promoted,kingMoves:e.kingMoves}}function de(e,t,n){return"p1"===e&&1===t[1]||"p2"===e&&t[1]===n[1]}function pe(e,t){return e[1]%2==0&&t[1]%2==0?[e[0]-t[0],e[1]-t[1],0,0,-.5]:e[1]%2!=0&&t[1]%2==0?[e[0]-t[0]+.5,e[1]-t[1],0,0,-.5]:e[1]%2==0&&t[1]%2!=0?[e[0]-t[0]-.5,e[1]-t[1],0,0,0]:[e[0]-t[0],e[1]-t[1],0,0,0]}function ue(e,t){let n=e.animation.current;if(void 0===n)return void(e.dom.destroyed||e.dom.redrawNow());let o=1-(t-n.start)*n.frequency;if(o<=0&&(n.plan.nextPlan&&!M(n.plan.nextPlan.anims)?(e.animation.current={start:performance.now(),frequency:2.2/e.animation.duration,plan:n.plan.nextPlan,lastMove:e.lastMove},n=e.animation.current,o=1-(performance.now()-n.start)*n.frequency):e.animation.current=void 0),void 0!==e.animation.current){o>.999&&(o=.999);const t=(r=o)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of n.plan.anims){const n=e[1];n[2]=n[0]*t,n[3]=n[1]*t}e.dom.redrawNow(!0),requestAnimationFrame(((t=performance.now())=>ue(e,t)))}else e.dom.redrawNow();var r}const ge=["green","red","blue","yellow"];function fe(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?$(e):Z(e);const n=w(t),o=Y(n,e.boardSize,J(e),e.dom.bounds());o&&(e.drawable.current={orig:o,pos:n,brush:ye(t)},he(e))}function he(e){requestAnimationFrame((()=>{const t=e.drawable.current;if(t){const n=Y(t.pos,e.boardSize,J(e),e.dom.bounds());n!==t.mouseSq&&(n?(t.mouseSq=n,t.prev=void 0,t.dest=n!==t.orig?n:void 0):(t.prev=t.mouseSq,t.mouseSq=void 0),e.dom.redrawNow()),he(e)}}))}function me(e,t){e.drawable.current&&(e.drawable.current.pos=w(t))}function ve(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const n=e=>e.orig===t.orig&&e.dest===t.dest,o=e.shapes.filter(n)[0];o&&(e.shapes=e.shapes.filter((e=>!n(e))));o&&o.brush===t.brush||e.shapes.push(t);we(e)}(e.drawable,t),be(e))}function be(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function ye(e){return ge[((e.shiftKey||e.ctrlKey)&&x(e)?1:0)+(e.altKey?2:0)]}function we(e){e.onChange&&e.onChange(e.shapes)}function xe(e){const t=J(e),n=e.boardSize,o=e.dom.relative?(M=n,(e,t,n)=>h(e,M,t,200/M[0],100/M[1],n)):m(e.dom.bounds(),n),r=e.dom.relative?b:v,a=e.dom.elements.board,i=e.pieces,s=e.animation.current,c=s?s.plan.anims:new Map,d=s?s.plan.captures:new Map,p=s?s.plan.tempRole:new Map,u=e.draggable.current,g=function(e){const t={};let n,o;if(e.lastMove&&e.highlight.lastMove)for(n in e.lastMove)e.lastMove[n]!==e.selected&&Le(t,e.lastMove[n],"last-move");if(e.selected&&(Le(t,e.selected,"selected"),e.movable.showDests)){const r=e.movable.dests&&e.movable.dests.get(e.selected);if(r)for(n in r)o=r[n],Le(t,o,"move-dest"+(e.pieces.has(o)?" oc":""));const a=e.premovable.dests;if(a)for(n in a)o=a[n],Le(t,o,"premove-dest"+(e.pieces.has(o)?" oc":""))}const r=e.premovable.current;if(r)for(n in r)Le(t,r[n],"current-premove");else e.predroppable.current&&Le(t,e.predroppable.current.key,"current-premove");const a=e.exploding;if(a)for(n in a.keys)Le(t,a.keys[n],"exploding"+a.stage);return t}(e),f={},y={},w=new Map,x=new Map;var M;let I,S,P,z,L,C,N,O,K,E,A,D=s&&s.lastMove&&s.lastMove.length>2&&s.lastMove[0]===s.lastMove[s.lastMove.length-1]?s.lastMove[0]:void 0;for(S=a.firstChild;S;){if(I=S.cgKey,ke(S))if(P=i.get(I),L=c.get(I),C=d.get(I),N=p.get(I),z=S.cgPiece,!S.cgDragging||u&&u.orig===I||(S.classList.remove("dragging"),r(S,o(l(I,n),t,0)),S.cgDragging=!1),S.classList.contains("temporary")&&C){const e=ze(C)+" temporary";z!==e&&(S.className=e),f[I]=!0}else if(P){if(L&&S.cgAnimating&&z===ze(P)){D=void 0;const e=l(I,n);if(e[0]+=L[2],e[1]+=L[3],s&&s.plan.nextPlan){const t=s.plan.nextPlan.anims.get(I);t&&(e[0]+=t[2],e[1]+=t[3])}S.classList.add("anim"),N?(S.className=S.className.replace(P.role,N),S.classList.add("temprole")):S.classList.contains("temprole")&&(S.classList.remove("temprole"),"king"===P.role?S.className=S.className.replace("man","king"):"man"===P.role&&(S.className=S.className.replace("king","man"))),r(S,o(e,t,L[4]))}else S.cgAnimating&&(S.cgAnimating=!1,S.classList.remove("anim"),S.classList.contains("temprole")&&(S.classList.remove("temprole"),"king"===P.role?S.className=S.className.replace("man","king"):"man"===P.role&&(S.className=S.className.replace("king","man"))),r(S,o(l(I,n),t,0)),e.addPieceZIndex&&(S.style.zIndex=Pe(l(I,n),t)));z===ze(P)&&I!==D?f[I]=!0:Ce(w,z,S)}else Ce(w,z,S);else if(Me(S)){const e=S.className;g[I]===e?y[I]=!0:Ce(x,e,S)}S=S.nextSibling}for(const h in g)if(!y[h]){E=x.get(g[h]),A=E&&E.pop();const e=o(l(h,n),t,0);if(A)A.cgKey=h,r(A,e);else{const t=k("square",g[h]);t.cgKey=h,r(t,e),a.insertBefore(t,a.firstChild)}}for(const[h,m]of i)if(L=c.get(h),C=d.get(h),N=p&&p.get(h),!f[h]&&!C)if(O=w.get(ze(m)),K=O&&O.pop(),K){K.cgKey=h;const a=l(h,n);let i;if(e.addPieceZIndex&&(K.style.zIndex=Pe(a,t)),L){if(K.cgAnimating=!0,K.classList.add("anim"),a[0]+=L[2],a[1]+=L[3],i=L[4],s&&s.plan.nextPlan){const e=s.plan.nextPlan.anims.get(h);e&&(a[0]+=e[2],a[1]+=e[3])}}else i=0;r(K,o(a,t,i))}else{const i=ze(m),s=k("piece",i),c=l(h,n);let d;s.cgPiece=i,s.cgKey=h,L?(s.cgAnimating=!0,c[0]+=L[2],c[1]+=L[3],d=L[4],N&&(s.className=s.className.replace(m.role,N),s.classList.add("temprole"))):d=0,r(s,o(c,t,d)),e.addPieceZIndex&&(s.style.zIndex=Pe(c,t)),a.appendChild(s)}for(const h in d)if(I=h,C=d.get(I),C&&!f[I]){const i=ze(C)+" temporary",s=k("piece",i),c=l(I,n);s.cgPiece=i,s.cgKey=I,r(s,o(c,t,0)),e.addPieceZIndex&&(s.style.zIndex=Pe(c,t)),a.appendChild(s)}for(const l of w.values())Se(e,l);for(const l of x.values())Se(e,l)}function ke(e){return"PIECE"===e.tagName}function Me(e){return"SQUARE"===e.tagName}function Ie(e){return"FIELDNUMBER"===e.tagName}function Se(e,t){for(const n in t)e.dom.elements.board.removeChild(t[n])}function Pe(e,t){let n=2+8*(e[1]-1)+(8-e[0]);return t&&(n=67-n),n+""}function ze(e){return"ghostman"===e.role?`${e.playerIndex} man ghost`:"ghostking"===e.role?e.kingMoves&&e.kingMoves>0?`${e.playerIndex} king ghost king${e.kingMoves}`:`${e.playerIndex} king ghost`:"king"===e.role&&e.kingMoves&&e.kingMoves>0?`${e.playerIndex} king king${e.kingMoves}`:`${e.playerIndex} ${e.role}`}function Le(e,t,n){e[t]?e[t]+=" "+n:e[t]=n}function Ce(e,t,n){const o=e.get(t);o?o.push(n):e.set(t,[n])}function Ne(e,t){if(!t.isTrusted||void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),o=e.boardSize,r=w(t),a=Y(r,o,J(e),n),i=!a&&Q(r,o,J(e),n);if(!a&&!i)return;const s=a&&e.pieces.get(a),c=e.selected;var d;if(c||!e.drawable.enabled||!e.drawable.eraseOnClick&&s&&s.playerIndex===e.turnPlayerIndex||(d=e).drawable.shapes.length&&(d.drawable.shapes=[],d.dom.redraw(),we(d.drawable)),!1===t.cancelable||t.touches&&e.movable.playerIndex&&!s&&!c&&!function(e,t){const n=J(e),o=e.dom.bounds(),r=Math.pow(o.width/10,2);for(const a in e.pieces){const i=We(a,e.boardSize,n,o),s=[i.left+i.width/2,i.top+i.height/2];if(g(s,t)<=r)return!0}return!1}(e,r)||t.preventDefault(),!a)return;const p=!!e.premovable.current,u=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&_(e,e.selected,a)?ie((e=>B(e,a)),e):B(e,a);const f=e.selected===a,h=qe(e,a);if(s&&h&&f&&function(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&("both"===e.movable.playerIndex||e.movable.playerIndex===n.playerIndex&&(e.turnPlayerIndex===n.playerIndex||e.premovable.enabled))}(e,a)){const i=We(a,o,J(e),n);e.draggable.current={orig:a,origPos:l(a,o),piece:s,rel:r,epos:r,pos:[0,0],dec:e.draggable.centerPiece?[r[0]-(i.left+i.width/2),r[1]-(i.top+i.height/2)]:[0,0],started:e.draggable.autoDistance&&e.stats.dragged,element:h,previouslySelected:c,originTarget:t.target},h.cgDragging=!0,h.classList.add("dragging");const d=e.dom.elements.ghost;d&&(d.className="ghost "+ze(s),v(d,m(n,o)(l(a,o),J(e),0))),Oe(e)}else p&&E(e),u&&A(e);e.dom.redraw()}function Oe(e){requestAnimationFrame((()=>{const t=e.draggable.current;if(!t)return;e.animation.current&&e.animation.current.plan.anims.has(t.orig)&&(e.animation.current=void 0);const n=e.pieces.get(t.orig);if(n&&f(n,t.piece)){if(!t.started&&g(t.epos,t.rel)>=Math.pow(e.draggable.distance,2)&&(t.started=!0),t.started){if("function"==typeof t.element){const e=t.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),t.element=e}t.pos=[t.epos[0]-t.rel[0],t.epos[1]-t.rel[1]];const n=m(e.dom.bounds(),e.boardSize)(t.origPos,J(e),0);n[0]+=t.pos[0]+t.dec[0],n[1]+=t.pos[1]+t.dec[1],v(t.element,n)}}else Ae(e);Oe(e)}))}function Ke(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.epos=w(t))}function Ee(e,t){const n=e.draggable.current;if(!n)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&n&&n.originTarget!==t.target&&!n.newPiece)return void(e.draggable.current=void 0);E(e),A(e);const o=w(t)||n.epos,r=Y(o,e.boardSize,J(e),e.dom.bounds()),a=!r&&Q(o,e.boardSize,J(e),e.dom.bounds()),i=n.started&&n.orig!==r;if(r&&i){if(n.newPiece)j(e,n.orig,r,n.force);else if(e.stats.ctrlKey=t.ctrlKey,ie((e=>R(e,n.orig,r)),e,!0)){e.stats.dragged=!0;const t=e.animateFrom?e.animateFrom+1:1;e.movable.captLen&&e.movable.captLen>(e.lastMove?e.lastMove.length-t:1)&&T(e,r)}}else n.newPiece?e.pieces.delete(n.orig):a&&i?$(e):e.draggable.deleteOnDropOff&&!r&&(e.pieces.delete(n.orig),K(e.events.change));(!n||n.orig!==n.previouslySelected||n.orig!==r&&r)&&e.selectable.enabled||$(e),De(e),e.draggable.current=void 0,e.dom.redraw()}function Ae(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,$(e),De(e),e.dom.redraw())}function De(e){const t=e.dom.elements;t.ghost&&y(t.ghost)}function We(e,t,n,o){const r=l(e,t),a=t[0],i=t[1];return n||(r[0]=a/2+1-r[0],r[1]=i+1-r[1]),{left:o.left+o.width*(2*(r[0]-1)+(r[1]%2!=0?1:0))/a,top:o.top+o.height*(r[1]-1)/i,width:o.width/a,height:o.height/i}}function qe(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&"PIECE"===n.tagName)return n;n=n.nextSibling}}function Fe(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Re(e,o){function r(){!function(e){e.orientation=p(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),o()}return{set(t,n=!1){t.orientation&&t.orientation!==e.orientation&&r(),t.fen?(ie((e=>ne(e,t)),e,!1,n),e.selected&&!e.pieces.get(e.selected)&&(e.selected=void 0)):se((e=>ne(e,t)),e)},state:e,getFen:o=>function(e,o,r){const a=o||50;let i="W",s="B";for(let l=1;l<=a;l++){const o=t[l-1],a=e.get(o);a&&("p1"===a.playerIndex?(i.length>1&&(i+=","),"king"===a.role?i+="K":"ghostman"===a.role?i+="G":"ghostking"===a.role&&(i+="P"),i+=r?n[l-1]:l.toString()):(s.length>1&&(s+=","),"king"===a.role?s+="K":"ghostman"===a.role?s+="G":"ghostking"===a.role&&(s+="P"),s+=r?n[l-1]:l.toString()))}return i+":"+s}(e.pieces,V(e),o),toggleOrientation:r,setPieces(t){ie((e=>function(e,t){for(const[n,o]of t)o?e.pieces.set(n,o):e.pieces.delete(n)}(e,t)),e)},selectSquare(t,n){t?ie((e=>B(e,t,n)),e):e.selected&&($(e),e.dom.redraw())},move(t,n,o){ie((e=>W(e,t,n,o)),e)},newPiece(t,n){ie((e=>q(e,t,n)),e)},setKingMoves(t){!function(e,t){const n=V(e);for(let o=1;o<=n;o++){const t=o<10?"0"+o.toString():o.toString(),n=e.pieces.get(t);n&&n.kingMoves&&(n.kingMoves=void 0)}oe(e,t)}(e,t)},playPremove(){if(e.premovable.current){const t=e.premovable.current?e.premovable.current[1]:"00";if(ie(G,e))return e.movable.captLen&&e.movable.captLen>1&&T(e,t),!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const n=function(e,t){const n=e.predroppable.current;let o=!1;if(!n)return!1;t(n)&&q(e,{role:n.role,playerIndex:e.movable.playerIndex},n.key)&&(K(e.movable.events.afterNewPiece,n.role,n.key,{predrop:!0}),o=!0);return A(e),o}(e,t);return e.dom.redraw(),n}return!1},cancelPremove(){se(E,e)},cancelPredrop(){se(A,e)},cancelMove(){se((e=>{Z(e),Ae(e)}),e)},stop(){se((e=>{X(e),Ae(e)}),e)},explode(t){!function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout((()=>{Fe(e,2),setTimeout((()=>Fe(e,void 0)),120)}),120)}(e,t)},setAutoShapes(t){se((e=>e.drawable.autoShapes=t),e)},setShapes(t){se((e=>e.drawable.shapes=t),e)},getKeyAtDomPos:t=>Y(t,e.boardSize,J(e),e.dom.bounds()),redrawAll:o,dragNewPiece(t,n,o){!function(e,t,n,o){const r="00";e.pieces.set(r,t),e.dom.redraw();const a=w(n),i=J(e),s=e.dom.bounds(),c=We(r,e.boardSize,i,s),d=[(i?-1:e.boardSize[0])*c.width+s.left,(i?0:e.boardSize[1]-1)*c.height+s.top];e.draggable.current={orig:r,origPos:l(r,e.boardSize),piece:t,rel:d,epos:a,pos:[a[0]-d[0],a[1]-d[1]],dec:[-c.width/2,-c.height/2],started:!0,element:()=>qe(e,r),originTarget:n.target,newPiece:!0,force:!!o},Oe(e)}(e,t,n,o)},destroy(){X(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function je(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Be(e,t){const n=e.drawable,o=n.current,r=o&&(o.mouseSq||o.prev)?o:void 0,a={},i=e.dom.bounds();n.shapes.concat(n.autoShapes).concat(r?[r]:[]).forEach((e=>{e.dest&&(a[e.dest]=(a[e.dest]||0)+1)}));const s=n.shapes.concat(n.autoShapes).map((e=>({shape:e,current:!1,hash:Te(e,a,!1,i)})));r&&s.push({shape:r,current:!0,hash:Te(r,a,!0,i)});const c=s.map((e=>e.hash)).join("");if(c===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=c;const d=t.firstChild;!function(e,t,n){const o={};let r;t.forEach((t=>{t.shape.dest&&(r=e.brushes[t.shape.brush],t.shape.modifiers&&(r=Ge(r,t.shape.modifiers)),o[r.key]=r)}));const a={};let i=n.firstChild;for(;i;)a[i.getAttribute("cgKey")]=!0,i=i.nextSibling;for(const s in o)a[s]||n.appendChild(Ue(o[s]))}(n,s,d),function(e,t,n,o,r,a){const i=e.dom.bounds(),s={},c=[];t.forEach((e=>{s[e.hash]=!1}));let d,p=a.nextSibling;for(;p;)d=p.getAttribute("cgHash"),Object.prototype.hasOwnProperty.call(s,d)?s[d]=!0:c.push(p),p=p.nextSibling;c.forEach((e=>r.removeChild(e))),t.forEach((t=>{s[t.hash]||r.appendChild(function(e,{shape:t,current:n,hash:o},r,a,i,s){let c;if(t.piece)c=function(e,t,n,o,r){const a=Ye(t,o,r),i=o.width/r[0]*(n.scale||1),s=n.playerIndex[0]+n.role[0].toUpperCase();return _e(je("image"),{className:`${n.role} ${n.playerIndex}`,x:a[0]-i/2,y:a[1]-i/2,width:i,height:i,href:e+s+".svg"})}(e.drawable.pieces.baseUrl,He(l(t.orig,e.boardSize),e.orientation,s),t.piece,i,s);else{const o=He(l(t.orig,e.boardSize),e.orientation,s);if(t.orig&&t.dest){let d=r[t.brush];t.modifiers&&(d=Ge(d,t.modifiers)),c=function(e,t,n,o,r,a,i){const s=function(e,t,n){return n[0]*(t?2:1)/512*e.width}(a,r&&!o,i),l=Ye(t,a,i),c=Ye(n,a,i),d=c[0]-l[0],p=c[1]-l[1],u=Math.atan2(p,d),g=Math.cos(u)*s,f=Math.sin(u)*s;return _e(je("line"),{stroke:e.color,"stroke-width":Ze(e,o,a,i),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:Xe(e,o),x1:l[0],y1:l[1],x2:c[0]-g,y2:c[1]-f})}(d,o,He(l(t.dest,e.boardSize),e.orientation,s),n,a[t.dest]>1,i,s)}else c=function(e,t,n,o,r){const a=Ye(t,o,r),i=function(e,t){const n=512*t[0]/10,o=e.width/n;return[3*o,4*o]}(o,r),s=(o.width+o.height)/(2*(r[0]+r[1]));return _e(je("circle"),{stroke:e.color,"stroke-width":i[n?0:1],fill:"none",opacity:Xe(e,n),cx:a[0],cy:a[1],r:s-i[1]/2})}(r[t.brush],o,n,i,s)}return c.setAttribute("cgHash",o),c}(e,t,n,o,i,e.boardSize))}))}(e,s,n.brushes,a,t,d)}function Te({orig:e,dest:t,brush:n,piece:o,modifiers:r},a,i,s){return[s.width,s.height,i,e,t,n,t&&a[t]>1,o&&$e(o),r&&(l=r,""+(l.lineWidth||""))].filter((e=>e)).join(",");var l}function $e(e){return[e.playerIndex,e.role,e.scale].filter((e=>e)).join(",")}function Ue(e){const t=_e(je("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(_e(je("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function _e(e,t){for(const n in t)e.setAttribute(n,t[n]);return e}function He(e,t,n){return"p1"===t?e:[n[0]/2+1-e[0],n[1]+1-e[1]]}function Ge(e,t){const n={color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth)};return n.key=[e.key,t.lineWidth].filter((e=>e)).join(""),n}function Ze(e,t,n,o){const r=512*o[0]/10;return(e.lineWidth||10)*(t?.85:1)/r*n.width}function Xe(e,t){return(e.opacity||1)*(t?.9:1)}function Ye(e,t,n){return[(2*e[0]-(e[1]%2!=0?.5:1.5))*t.width/n[0],(e[1]-.5)*t.height/n[1]]}function Qe(n,o,i){n.innerHTML="",n.classList.add("cg-wrap"),e.forEach((e=>n.classList.toggle("orientation-"+e,o.orientation===e))),n.classList.toggle("manipulable",!o.viewOnly);const s=k("cg-helper");n.appendChild(s);const c=k("cg-container");s.appendChild(c);const d=k("cg-board");let p,u;if(c.appendChild(d),o.drawable.visible&&!i&&(p=je("svg"),p.appendChild(je("defs")),c.appendChild(p)),o.coordinates)if(2===o.coordinates)if(1===o.coordSystem){const e="is64"+("p2"===o.orientation?" p2":" p1");c.appendChild(Je(r,"ranks "+e)),c.appendChild(Je(a,"files "+e))}else{const e=[],t=[],n=o.boardSize[0]/2,r=o.boardSize[0]*o.boardSize[1]/2,a=o.boardSize[1]/2,i="is"+2*r+("p2"===o.orientation?" p2":"");if(0===o.coordSystem)if("p2"===o.orientation){for(let t=1;t<=n;t++)e.push(t);for(let e=a-1;e>=0;e--)t.push(n+o.boardSize[0]*e+1)}else{for(let t=r-n+1;t<=r;t++)e.push(t);for(let e=0;e<a;e++)t.push(n+o.boardSize[0]*e)}else if("p2"===o.orientation){for(let t=r;t>r-n;t--)e.push(t);for(let e=0;e<a;e++)t.push(n+o.boardSize[0]*e)}else{for(let t=n;t>0;t--)e.push(t);for(let e=a;e>0;e--)t.push(o.boardSize[0]*e-n+1)}c.appendChild(Je(t,"ranks "+i)),c.appendChild(Je(e,"files "+i))}else i||1!==o.coordinates||function(e,n,o){const r="p2"!==n.orientation,a=V(n);for(let i=1;i<=a;i++){const a=k("fieldnumber","p2"),s=i.toString(),c=t[i-1];a.textContent=Ve(n.coordSystem,s),a.cgKey=c;const d=m(o,n.boardSize)(l(c,n.boardSize),r,0);v(a,[d[0],d[1]]),e.appendChild(a)}}(d,o,d.getBoundingClientRect());return o.draggable.showGhost&&!i&&(u=k("piece","ghost"),y(u),c.appendChild(u)),{board:d,container:c,ghost:u,svg:p}}function Ve(e,t){return 1===e?o[t]:2===e?(33-+t).toString():t}function Je(e,t){const n=k("coords",t);let o;for(const r in e)o=k("coord"),o.textContent=e[r],n.appendChild(o);return n}function et(e,t){const n=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window){new window.ResizeObserver(t).observe(n)}if(e.viewOnly)return;const o=function(e){return t=>{e.draggable.current?Ae(e):e.drawable.current?be(e):t.shiftKey||x(t)?e.drawable.enabled&&fe(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;if(E(e),A(e),e.dropmode.piece){const n=w(t),o=n&&Y(n,e.boardSize,J(e),e.dom.bounds());o&&j(e,"00",o)}e.dom.redraw()}(e,t):Ne(e,t))}}(e);n.addEventListener("touchstart",o,{passive:!1}),n.addEventListener("mousedown",o,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",(e=>e.preventDefault()))}function tt(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n)}function nt(e,t,n){return o=>{o.shiftKey||x(o)?e.drawable.enabled&&n(e,o):e.viewOnly||t(e,o)}}function ot(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame((()=>{e(),t=!1})))}}function rt(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach((function(n){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,o.get?o:{enumerable:!0,get:function(){return e[n]}})})),t}return rt(Object.freeze({__proto__:null,Draughtsground:function(e,t){const n={pieces:te(ee),boardSize:[10,10],orientation:"p1",turnPlayerIndex:"p1",coordinates:2,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,kingMoves:!0},animation:{enabled:!0,duration:200},movable:{free:!0,playerIndex:"both",showDests:!0,events:{}},premovable:{enabled:!0,showDests:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,centerPiece:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleBlue2:{key:"pb2",color:"#003088",opacity:.65,lineWidth:15},paleBlue3:{key:"pb3",color:"#003088",opacity:.3,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://playstrategy.org/assets/piece/draughts/wide_crown/"},prevSvgHash:""},hold:d()};function o(){const t=n.dom&&n.dom.unbind,o=n.viewOnly&&!n.drawable.visible,r=Qe(e,n,o),a=function(e){let t;const n=()=>(void 0===t&&(t=e()),t);return n.clear=()=>{t=void 0},n}((()=>r.board.getBoundingClientRect())),i=e=>{xe(n),!e&&r.svg&&Be(n,r.svg)},s=()=>{a.clear(),function(e){if(e.dom.relative)return;const t=J(e),n=m(e.dom.bounds(),e.boardSize);let o=e.dom.elements.board.firstChild;for(;o;)(ke(o)&&!o.cgAnimating||Me(o)||Ie(o))&&v(o,n(l(o.cgKey,e.boardSize),t,0)),o=o.nextSibling}(n),r.svg&&Be(n,r.svg)};n.dom={elements:r,bounds:a,redraw:ot(i),redrawNow:i,unbind:t,relative:o},n.drawable.prevSvgHash="",i(!1),et(n,s),t||(n.dom.unbind=function(e,t){const n=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||n.push(tt(document.body,"draughtsground.resize",t)),!e.viewOnly){const t=nt(e,Ke,me),o=nt(e,Ee,ve);["touchmove","mousemove"].forEach((e=>n.push(tt(document,e,t)))),["touchend","mouseup"].forEach((e=>n.push(tt(document,e,o))));const r=()=>e.dom.bounds.clear();n.push(tt(window,"scroll",r,{passive:!0})),n.push(tt(window,"resize",r,{passive:!0}))}return()=>n.forEach((e=>e()))}(n,s)),n.events.insert&&n.events.insert(r)}return ne(n,t||{}),o(),Re(n,o)}})).Draughtsground}();
